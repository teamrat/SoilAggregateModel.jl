# CLAUDE.md ‚Äî Instructions for Claude Code

## Project
Soil aggregate biogeochemical model in Julia. Reaction-diffusion PDEs on a spherical domain.

## Authoritative Documents
1. **Manuscript (Overleaf)** ‚Äî Physics specification. All equations, boundary conditions, and process descriptions come from here. If in doubt, the manuscript wins.
2. **`docs/ARCHITECTURE.md`** ‚Äî Implementation architecture. Solver design, data structures, file layout, performance targets, implementation order. Follow it.

**Read both before making any structural decisions.**

## Key Rules
- **Zero allocations in the hot loop.** Every array must be pre-allocated in Workspace. Use `@allocated` to verify.
- **Units**: Œºg/mm¬≥ (= kg/m¬≥), mm, days, kPa, K, J/mol. No conversions needed except for literature diffusion values (cm¬≤/s ‚Üí mm¬≤/day: multiply by 8.64√ó10‚Å∂).
- **Symbol ùìî_a** (`\mathcal{E}_a` in LaTeX) is activation energy. **E** (no calligraphic) is EPS. Do not confuse them.
- **Test each module before building the next.** Follow the implementation order in Section 15 of the architecture.
- **Do not use DifferentialEquations.jl** unless explicitly asked. The solver is custom (Strang splitting + Thomas algorithm).

## Julia Style
- Use `!` suffix for mutating functions (e.g., `diffusion_step!`, `update_temperature_cache!`)
- Concrete types everywhere ‚Äî no `::Function` or `::Any` in hot-path structs
- `@inbounds` on inner loops after correctness is verified
- Prefer `for i in eachindex(x)` over `for i in 1:length(x)`

## Testing
- Each `src/` module gets a corresponding `test/` file
- Run tests with `julia --project test/runtests.jl`
- Carbon conservation must hold to machine precision (< 1e-12 relative error)

## Repository Structure
- `src/` ‚Äî The Julia package. All model code lives here.
- `test/` ‚Äî Unit and integration tests. Run with `julia --project -e 'using Pkg; Pkg.test()'`
- `scripts/` ‚Äî Development/debugging scripts. Not part of the package.
- `paper/simulations/` ‚Äî Scripts that generate paper figures. Each includes `common.jl`.
- `paper/figures/` ‚Äî Generated figures. Synced to Overleaf via Dropbox. Gitignored.
- `docs/` ‚Äî Architecture, guides, bug reports.
- `docs/archive/` ‚Äî Historical fix notes and changelogs.

## Overleaf Workflow
Figures are generated by scripts in `paper/simulations/`, saved to `paper/figures/`,
and synced to Overleaf via Dropbox. The manuscript .tex file lives ONLY on Overleaf ‚Äî
do not create or edit .tex files in this repository.

## File Creation Rules
- Model code ‚Üí `src/` (appropriate subdirectory)
- Tests ‚Üí `test/`
- Quick diagnostic/debug scripts ‚Üí `scripts/`
- Paper figure generation ‚Üí `paper/simulations/`
- Documentation ‚Üí `docs/`
- Never put scripts or notebooks in `src/`
